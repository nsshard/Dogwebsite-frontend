{"ast":null,"code":"const scmp = require('scmp');\n\nconst pbkdf2 = require('./pbkdf2');\n\nconst errors = require('./errors'); // authenticate function needs refactoring - to avoid bugs we wrapped a bit dirty\n\n\nmodule.exports = function (user, password, options, cb) {\n  if (cb) {\n    return authenticate(user, password, options, cb);\n  }\n\n  return new Promise((resolve, reject) => {\n    authenticate(user, password, options, (err, user, error) => err ? reject(err) : resolve({\n      user,\n      error\n    }));\n  });\n};\n\nfunction authenticate(user, password, options, cb) {\n  if (options.limitAttempts) {\n    const attemptsInterval = Math.pow(options.interval, Math.log(user.get(options.attemptsField) + 1));\n    const calculatedInterval = attemptsInterval < options.maxInterval ? attemptsInterval : options.maxInterval;\n\n    if (Date.now() - user.get(options.lastLoginField) < calculatedInterval) {\n      user.set(options.lastLoginField, Date.now());\n      user.save(function (saveErr) {\n        if (saveErr) {\n          return cb(saveErr);\n        }\n\n        return cb(null, false, new errors.AttemptTooSoonError(options.errorMessages.AttemptTooSoonError));\n      });\n      return;\n    }\n\n    if (user.get(options.attemptsField) >= options.maxAttempts) {\n      if (options.unlockInterval && Date.now() - user.get(options.lastLoginField) > options.unlockInterval) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, 0);\n        user.save();\n      } else {\n        return cb(null, false, new errors.TooManyAttemptsError(options.errorMessages.TooManyAttemptsError));\n      }\n    }\n  }\n\n  if (!user.get(options.saltField)) {\n    return cb(null, false, new errors.NoSaltValueStoredError(options.errorMessages.NoSaltValueStoredError));\n  }\n\n  pbkdf2(password, user.get(options.saltField), options, function (err, hashBuffer) {\n    if (err) {\n      return cb(err);\n    }\n\n    if (scmp(hashBuffer, Buffer.from(user.get(options.hashField), options.encoding))) {\n      if (options.limitAttempts) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, 0);\n        user.save(function (saveErr, user) {\n          if (saveErr) {\n            return cb(saveErr);\n          }\n\n          return cb(null, user);\n        });\n      } else {\n        return cb(null, user);\n      }\n    } else {\n      if (options.limitAttempts) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, user.get(options.attemptsField) + 1);\n        user.save(function (saveErr) {\n          if (saveErr) {\n            return cb(saveErr);\n          }\n\n          if (user.get(options.attemptsField) >= options.maxAttempts) {\n            return cb(null, false, new errors.TooManyAttemptsError(options.errorMessages.TooManyAttemptsError));\n          } else {\n            return cb(null, false, new errors.IncorrectPasswordError(options.errorMessages.IncorrectPasswordError));\n          }\n        });\n      } else {\n        return cb(null, false, new errors.IncorrectPasswordError(options.errorMessages.IncorrectPasswordError));\n      }\n    }\n  });\n}","map":{"version":3,"names":["scmp","require","pbkdf2","errors","module","exports","user","password","options","cb","authenticate","Promise","resolve","reject","err","error","limitAttempts","attemptsInterval","Math","pow","interval","log","get","attemptsField","calculatedInterval","maxInterval","Date","now","lastLoginField","set","save","saveErr","AttemptTooSoonError","errorMessages","maxAttempts","unlockInterval","TooManyAttemptsError","saltField","NoSaltValueStoredError","hashBuffer","Buffer","from","hashField","encoding","IncorrectPasswordError"],"sources":["C:/Users/Administrator/Desktop/webAPI work/web/dog-website/node_modules/passport-local-mongoose/lib/authenticate.js"],"sourcesContent":["const scmp = require('scmp');\n\nconst pbkdf2 = require('./pbkdf2');\nconst errors = require('./errors');\n\n// authenticate function needs refactoring - to avoid bugs we wrapped a bit dirty\nmodule.exports = function (user, password, options, cb) {\n  if (cb) {\n    return authenticate(user, password, options, cb);\n  }\n\n  return new Promise((resolve, reject) => {\n    authenticate(user, password, options, (err, user, error) => (err ? reject(err) : resolve({ user, error })));\n  });\n};\n\nfunction authenticate(user, password, options, cb) {\n  if (options.limitAttempts) {\n    const attemptsInterval = Math.pow(options.interval, Math.log(user.get(options.attemptsField) + 1));\n    const calculatedInterval = attemptsInterval < options.maxInterval ? attemptsInterval : options.maxInterval;\n\n    if (Date.now() - user.get(options.lastLoginField) < calculatedInterval) {\n      user.set(options.lastLoginField, Date.now());\n      user.save(function (saveErr) {\n        if (saveErr) {\n          return cb(saveErr);\n        }\n        return cb(null, false, new errors.AttemptTooSoonError(options.errorMessages.AttemptTooSoonError));\n      });\n      return;\n    }\n\n    if (user.get(options.attemptsField) >= options.maxAttempts) {\n      if (options.unlockInterval && Date.now() - user.get(options.lastLoginField) > options.unlockInterval) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, 0);\n        user.save();\n      } else {\n        return cb(null, false, new errors.TooManyAttemptsError(options.errorMessages.TooManyAttemptsError));\n      }\n    }\n  }\n\n  if (!user.get(options.saltField)) {\n    return cb(null, false, new errors.NoSaltValueStoredError(options.errorMessages.NoSaltValueStoredError));\n  }\n\n  pbkdf2(password, user.get(options.saltField), options, function (err, hashBuffer) {\n    if (err) {\n      return cb(err);\n    }\n\n    if (scmp(hashBuffer, Buffer.from(user.get(options.hashField), options.encoding))) {\n      if (options.limitAttempts) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, 0);\n        user.save(function (saveErr, user) {\n          if (saveErr) {\n            return cb(saveErr);\n          }\n          return cb(null, user);\n        });\n      } else {\n        return cb(null, user);\n      }\n    } else {\n      if (options.limitAttempts) {\n        user.set(options.lastLoginField, Date.now());\n        user.set(options.attemptsField, user.get(options.attemptsField) + 1);\n        user.save(function (saveErr) {\n          if (saveErr) {\n            return cb(saveErr);\n          }\n          if (user.get(options.attemptsField) >= options.maxAttempts) {\n            return cb(null, false, new errors.TooManyAttemptsError(options.errorMessages.TooManyAttemptsError));\n          } else {\n            return cb(null, false, new errors.IncorrectPasswordError(options.errorMessages.IncorrectPasswordError));\n          }\n        });\n      } else {\n        return cb(null, false, new errors.IncorrectPasswordError(options.errorMessages.IncorrectPasswordError));\n      }\n    }\n  });\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}