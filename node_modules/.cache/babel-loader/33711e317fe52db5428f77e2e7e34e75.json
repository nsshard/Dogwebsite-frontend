{"ast":null,"code":"'use strict';\n\nconst OperationBase = require('./operation').OperationBase;\n\nconst applyRetryableWrites = require('../utils').applyRetryableWrites;\n\nconst applyWriteConcern = require('../utils').applyWriteConcern;\n\nconst decorateWithCollation = require('../utils').decorateWithCollation;\n\nconst executeCommand = require('./db_ops').executeCommand;\n\nconst formattedOrderClause = require('../utils').formattedOrderClause;\n\nconst handleCallback = require('../utils').handleCallback;\n\nconst ReadPreference = require('../core').ReadPreference;\n\nconst maxWireVersion = require('../core/utils').maxWireVersion;\n\nconst MongoError = require('../error').MongoError;\n\nclass FindAndModifyOperation extends OperationBase {\n  constructor(collection, query, sort, doc, options) {\n    super(options);\n    this.collection = collection;\n    this.query = query;\n    this.sort = sort;\n    this.doc = doc;\n  }\n\n  execute(callback) {\n    const coll = this.collection;\n    const query = this.query;\n    const sort = formattedOrderClause(this.sort);\n    const doc = this.doc;\n    let options = this.options; // Create findAndModify command object\n\n    const queryObject = {\n      findAndModify: coll.collectionName,\n      query: query\n    };\n\n    if (sort) {\n      queryObject.sort = sort;\n    }\n\n    queryObject.new = options.new ? true : false;\n    queryObject.remove = options.remove ? true : false;\n    queryObject.upsert = options.upsert ? true : false;\n    const projection = options.projection || options.fields;\n\n    if (projection) {\n      queryObject.fields = projection;\n    }\n\n    if (options.arrayFilters) {\n      queryObject.arrayFilters = options.arrayFilters;\n    }\n\n    if (doc && !options.remove) {\n      queryObject.update = doc;\n    }\n\n    if (options.maxTimeMS) queryObject.maxTimeMS = options.maxTimeMS; // Either use override on the function, or go back to default on either the collection\n    // level or db\n\n    options.serializeFunctions = options.serializeFunctions || coll.s.serializeFunctions; // No check on the documents\n\n    options.checkKeys = false; // Final options for retryable writes and write concern\n\n    options = applyRetryableWrites(options, coll.s.db);\n    options = applyWriteConcern(options, {\n      db: coll.s.db,\n      collection: coll\n    }, options); // Decorate the findAndModify command with the write Concern\n\n    if (options.writeConcern) {\n      queryObject.writeConcern = options.writeConcern;\n    } // Have we specified bypassDocumentValidation\n\n\n    if (options.bypassDocumentValidation === true) {\n      queryObject.bypassDocumentValidation = options.bypassDocumentValidation;\n    }\n\n    options.readPreference = ReadPreference.primary; // Have we specified collation\n\n    try {\n      decorateWithCollation(queryObject, coll, options);\n    } catch (err) {\n      return callback(err, null);\n    }\n\n    if (options.hint) {\n      // TODO: once this method becomes a CommandOperationV2 we will have the server\n      // in place to check.\n      const unacknowledgedWrite = options.writeConcern && options.writeConcern.w === 0;\n\n      if (unacknowledgedWrite || maxWireVersion(coll.s.topology) < 8) {\n        callback(new MongoError('The current topology does not support a hint on findAndModify commands'));\n        return;\n      }\n\n      queryObject.hint = options.hint;\n    } // Execute the command\n\n\n    executeCommand(coll.s.db, queryObject, options, (err, result) => {\n      if (err) return handleCallback(callback, err, null);\n      return handleCallback(callback, null, result);\n    });\n  }\n\n}\n\nmodule.exports = FindAndModifyOperation;","map":{"version":3,"names":["OperationBase","require","applyRetryableWrites","applyWriteConcern","decorateWithCollation","executeCommand","formattedOrderClause","handleCallback","ReadPreference","maxWireVersion","MongoError","FindAndModifyOperation","constructor","collection","query","sort","doc","options","execute","callback","coll","queryObject","findAndModify","collectionName","new","remove","upsert","projection","fields","arrayFilters","update","maxTimeMS","serializeFunctions","s","checkKeys","db","writeConcern","bypassDocumentValidation","readPreference","primary","err","hint","unacknowledgedWrite","w","topology","result","module","exports"],"sources":["C:/Users/Administrator/Desktop/webAPI work/web/dog-website/node_modules/koa-mongo/node_modules/mongodb/lib/operations/find_and_modify.js"],"sourcesContent":["'use strict';\n\nconst OperationBase = require('./operation').OperationBase;\nconst applyRetryableWrites = require('../utils').applyRetryableWrites;\nconst applyWriteConcern = require('../utils').applyWriteConcern;\nconst decorateWithCollation = require('../utils').decorateWithCollation;\nconst executeCommand = require('./db_ops').executeCommand;\nconst formattedOrderClause = require('../utils').formattedOrderClause;\nconst handleCallback = require('../utils').handleCallback;\nconst ReadPreference = require('../core').ReadPreference;\nconst maxWireVersion = require('../core/utils').maxWireVersion;\nconst MongoError = require('../error').MongoError;\n\nclass FindAndModifyOperation extends OperationBase {\n  constructor(collection, query, sort, doc, options) {\n    super(options);\n\n    this.collection = collection;\n    this.query = query;\n    this.sort = sort;\n    this.doc = doc;\n  }\n\n  execute(callback) {\n    const coll = this.collection;\n    const query = this.query;\n    const sort = formattedOrderClause(this.sort);\n    const doc = this.doc;\n    let options = this.options;\n\n    // Create findAndModify command object\n    const queryObject = {\n      findAndModify: coll.collectionName,\n      query: query\n    };\n\n    if (sort) {\n      queryObject.sort = sort;\n    }\n\n    queryObject.new = options.new ? true : false;\n    queryObject.remove = options.remove ? true : false;\n    queryObject.upsert = options.upsert ? true : false;\n\n    const projection = options.projection || options.fields;\n\n    if (projection) {\n      queryObject.fields = projection;\n    }\n\n    if (options.arrayFilters) {\n      queryObject.arrayFilters = options.arrayFilters;\n    }\n\n    if (doc && !options.remove) {\n      queryObject.update = doc;\n    }\n\n    if (options.maxTimeMS) queryObject.maxTimeMS = options.maxTimeMS;\n\n    // Either use override on the function, or go back to default on either the collection\n    // level or db\n    options.serializeFunctions = options.serializeFunctions || coll.s.serializeFunctions;\n\n    // No check on the documents\n    options.checkKeys = false;\n\n    // Final options for retryable writes and write concern\n    options = applyRetryableWrites(options, coll.s.db);\n    options = applyWriteConcern(options, { db: coll.s.db, collection: coll }, options);\n\n    // Decorate the findAndModify command with the write Concern\n    if (options.writeConcern) {\n      queryObject.writeConcern = options.writeConcern;\n    }\n\n    // Have we specified bypassDocumentValidation\n    if (options.bypassDocumentValidation === true) {\n      queryObject.bypassDocumentValidation = options.bypassDocumentValidation;\n    }\n\n    options.readPreference = ReadPreference.primary;\n\n    // Have we specified collation\n    try {\n      decorateWithCollation(queryObject, coll, options);\n    } catch (err) {\n      return callback(err, null);\n    }\n\n    if (options.hint) {\n      // TODO: once this method becomes a CommandOperationV2 we will have the server\n      // in place to check.\n      const unacknowledgedWrite = options.writeConcern && options.writeConcern.w === 0;\n      if (unacknowledgedWrite || maxWireVersion(coll.s.topology) < 8) {\n        callback(\n          new MongoError('The current topology does not support a hint on findAndModify commands')\n        );\n\n        return;\n      }\n\n      queryObject.hint = options.hint;\n    }\n\n    // Execute the command\n    executeCommand(coll.s.db, queryObject, options, (err, result) => {\n      if (err) return handleCallback(callback, err, null);\n\n      return handleCallback(callback, null, result);\n    });\n  }\n}\n\nmodule.exports = FindAndModifyOperation;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}